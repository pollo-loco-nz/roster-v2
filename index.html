<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chore Roster</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        h1 { text-align: center; color: #4f46e5; margin-top: 0; }
        select, button { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; font-weight: bold; }
        button { background: #4f46e5; color: white; border: none; cursor: pointer; }
        .gen-btn { background: #10b981; margin-top: 20px; font-size: 18px; }
        .day-box { margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .day-title { color: #4f46e5; text-transform: uppercase; font-size: 14px; letter-spacing: 1px; margin-bottom: 10px; display: flex; justify-content: space-between; font-weight: bold; }
        .chore-row { display: flex; align-items: center; justify-content: space-between; background: #fff; border: 1px solid #eee; padding: 12px; border-radius: 8px; margin-bottom: 8px; }
        .chore-row.active { border-color: #4f46e5; background: #f5f3ff; }
        input[type="checkbox"] { width: 22px; height: 22px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #4f46e5; color: white; }
        .day-head { background: #f8fafc; font-weight: bold; text-align: center; color: #64748b; font-size: 12px; }
    </style>
</head>
<body>

    <div class="card">
        <h1 style="font-style: italic;">CHORE-O-MATIC</h1>
        
        <label><b>1. Who is entering data?</b></label>
        <select id="userSelect" onchange="renderAvailability()">
            <option value="">-- Select Name --</option>
            <option value="Nathan">Nathan</option>
            <option value="Sam">Sam</option>
            <option value="Hannah">Hannah</option>
            <option value="Emily">Emily</option>
        </select>

        <div id="availSection" style="display:none;">
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <h3>2. Availability</h3>
                <button onclick="setAll(false)" style="width:auto; padding: 5px 10px; font-size: 10px; background: #ef4444;">NONE</button>
            </div>
            <div id="choreList"></div>
            <button onclick="saveData()">SAVE PREFERENCES</button>
        </div>

        <button class="gen-btn" onclick="generate()">GENERATE WEEKLY ROSTER</button>
        <div id="result"></div>
        
        <p style="text-align:center; font-size: 10px; color: #999; margin-top: 30px; cursor: pointer;" onclick="if(confirm('Reset all?')) { localStorage.clear(); location.reload(); }">RESET ALL FAMILY DATA</p>
    </div>

<script>
    const users = ["Nathan", "Sam", "Hannah", "Emily"];
    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

    function getChores(day) {
        if (day === "Saturday") return ["Pre-dinner", "Cook", "Post-dinner", "Vacuum Upstairs", "Vacuum Downstairs", "Bathroom"];
        return ["Pre-dinner", "Cook", "Post-dinner"];
    }

    function renderAvailability() {
        const user = document.getElementById('userSelect').value;
        const section = document.getElementById('availSection');
        const list = document.getElementById('choreList');
        if (!user) { section.style.display = 'none'; return; }
        section.style.display = 'block';
        list.innerHTML = '';

        const saved = JSON.parse(localStorage.getItem('v4_' + user)) || null;

        days.forEach(day => {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'day-box';
            let html = `<div class="day-title"><b>${day}</b> <span onclick="clearDay('${day}')" style="color:#ef4444; font-size:10px; cursor:pointer;">UNAVAILABLE</span></div>`;
            
            getChores(day).forEach(chore => {
                const id = day + '-' + chore;
                const checked = (saved === null) ? true : saved.includes(id);
                html += `
                    <div class="chore-row ${checked ? 'active' : ''}">
                        <span>${chore}</span>
                        <input type="checkbox" value="${id}" class="c-box" ${checked ? 'checked' : ''} onchange="this.parentElement.classList.toggle('active')">
                    </div>
                `;
            });
            dayDiv.innerHTML = html;
            list.appendChild(dayDiv);
        });
    }

    function clearDay(day) {
        const boxes = document.querySelectorAll('.c-box');
        boxes.forEach(b => { if(b.value.startsWith(day)) { b.checked = false; b.parentElement.classList.remove('active'); }});
    }

    function setAll(val) {
        const boxes = document.querySelectorAll('.c-box');
        boxes.forEach(b => { 
            b.checked = val; 
            if(val) b.parentElement.classList.add('active'); 
            else b.parentElement.classList.remove('active');
        });
    }

    function saveData() {
        const user = document.getElementById('userSelect').value;
        const checked = Array.from(document.querySelectorAll('.c-box:checked')).map(b => b.value);
        localStorage.setItem('v4_' + user, JSON.stringify(checked));
        alert("Preferences saved for " + user);
        window.scrollTo(0,0);
    }

    function isOk(p, d, c) {
        const data = JSON.parse(localStorage.getItem('v4_' + p));
        if (data === null) return true;
        return data.includes(d + '-' + c);
    }

    function generate() {
        let tally = { Nathan:0, Sam:0, Hannah:0, Emily:0 };
        let cooks = {};
        let monThu = ["Monday", "Tuesday", "Wednesday", "Thursday"];
        
        // --- COOKING RULES ---
        let sDay = monThu.find(d => isOk("Sam", d, "Cook"));
        if (sDay) cooks[sDay] = "Sam";
        let hDay = monThu.find(d => isOk("Hannah", d, "Cook") && d !== sDay);
        if (hDay) cooks[hDay] = "Hannah";
        days.forEach(d => { if (!cooks[d]) cooks[d] = "Nathan"; });

        let nOut = days.filter(d => cooks[d] === "Nathan" && !isOk("Nathan", d, "Cook")).length;

        // --- BUILD TABLE ---
        let html = '<table><tr><th>Job</th><th>Who</th></tr>';
        days.forEach(day => {
            html += `<tr><td colspan="2" class="day-head">${day.toUpperCase()}</td></tr>`;
            getChores(day).forEach(chore => {
                let p = "UNASSIGNED âš ï¸";

                if (chore === "Cook") {
                    let chef = cooks[day];
                    if (chef === "Nathan" && nOut > 2 && !isOk("Nathan", day, "Cook")) p = "TAKEOUT! ðŸ•";
                    else if (isOk(chef, day, "Cook")) p = chef;
                    else p = users.find(u => isOk(u, day, "Cook")) || "TAKEOUT! ðŸ•";
                } else {
                    // --- NON-COOKING FAIRNESS + NEW VACUUM RULES ---
                    let avail = users.filter(u => isOk(u, day, chore));

                    // Rule: Only Hannah & Sam for Vacuum Downstairs
                    if (chore === "Vacuum Downstairs") {
                        avail = avail.filter(u => u === "Hannah" || u === "Sam");
                    }
                    // Rule: Only Nathan for Vacuum Upstairs
                    if (chore === "Vacuum Upstairs") {
                        avail = avail.filter(u => u === "Nathan");
                    }

                    if (avail.length > 0) {
                        avail.sort((a,b) => tally[a] - tally[b]);
                        p = avail[0];
                        tally[p]++;
                    }
                }
                html += `<tr><td style="font-size: 13px; color: #666;">${chore}</td><td style="font-weight:bold; color:#4f46e5">${p}</td></tr>`;
            });
        });
        html += '</table>';
        document.getElementById('result').innerHTML = html;
        document.getElementById('result').scrollIntoView({behavior: "smooth"});
    }
</script>
</body>
</html>
