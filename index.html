<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Chore-O-Matic</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; padding: 20px; color: #333; line-height: 1.4; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 1100px; margin: auto; }
        h1 { text-align: center; color: #4f46e5; margin-top: 0; font-style: italic; text-transform: uppercase; }
        
        /* UI Elements */
        select, button { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid #ddd; font-size: 16px; font-weight: bold; }
        button { background: #4f46e5; color: white; border: none; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        .gen-btn { background: #10b981; margin-top: 15px; font-size: 18px; }
        
        /* Availability List */
        .day-box { margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .day-title { color: #4f46e5; text-transform: uppercase; font-size: 14px; display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 10px; }
        .chore-row { display: flex; align-items: center; justify-content: space-between; background: #fff; border: 1px solid #eee; padding: 12px; border-radius: 10px; margin-bottom: 8px; }
        .chore-row.active { border-color: #4f46e5; background: #f5f3ff; }
        input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; }

        /* Roster Grid */
        .table-container { width: 100%; overflow-x: auto; margin-top: 30px; border-radius: 15px; border: 2px solid #4f46e5; }
        table { width: 100%; border-collapse: collapse; background: white; min-width: 900px; }
        th, td { padding: 12px; text-align: center; border: 1px solid #eef2f6; }
        th { background: #4f46e5; color: white; font-size: 11px; }
        .chore-col { background: #f8fafc; font-weight: bold; color: #64748b; text-align: left; width: 160px; font-size: 12px; }
        .date-label { display: block; font-size: 14px; font-weight: 900; color: #c7d2fe; margin-top: 4px; }
        .person-val { font-weight: 800; color: #1e1b4b; }
        .takeout { color: #ef4444; font-weight: 900; }
        
        .status { text-align: center; font-size: 10px; font-weight: bold; color: #10b981; margin-bottom: 10px; text-transform: uppercase; }
    </style>
</head>
<body onload="init()">

    <div class="card">
        <h1>Chore-O-Matic Cloud</h1>
        <div id="dbStatus" class="status">‚óè Connecting to Database...</div>
        
        <label><b>1. Who are you?</b></label>
        <select id="userSelect" onchange="loadUser()">
            <option value="">-- Choose Name --</option>
            <option value="Nathan">Nathan</option>
            <option value="Sam">Sam</option>
            <option value="Hannah">Hannah</option>
            <option value="Emily">Emily</option>
        </select>

        <div id="availSection" style="display:none;">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin:0;">2. Your Availability</h3>
                <button onclick="setAll(false)" style="width:auto; padding: 5px 12px; font-size: 10px; background: #ef4444; margin:0;">CLEAR ALL</button>
            </div>
            <div id="choreList"></div>
            <button id="saveBtn" onclick="saveToCloud()">SAVE TO CLOUD</button>
        </div>

        <hr style="margin: 40px 0; border: 0; border-top: 2px dashed #cbd5e1;">

        <label><b>3. Generate Roster</b></label>
        <select id="weekSelect"></select>
        <button class="gen-btn" onclick="generate()">GENERATE GRID ROSTER</button>
        
        <div id="result" class="table-container"></div>
        
        <p style="text-align:center; font-size: 10px; color: #999; margin-top: 40px; cursor: pointer;" onclick="hardReset()">RESET SHARED DATABASE</p>
    </div>

<script>
    // --- DATABASE CONFIGURATION ---
    const SB_URL = 'https://zrsncawiesvswjjbxplx.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpyc25jYXdpZXN2c3dqamJ4cGx4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMzAwNTAsImV4cCI6MjA4NTkwNjA1MH0.tr9jvGU9PqsHf0bA4AAjBYXVYtgGJIMMO7Go2wQHxTI';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    const users = ["Nathan", "Sam", "Hannah", "Emily"];
    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
    const dinnerChores = ["Pre-dinner", "Cook", "Post-dinner"];
    const saturdayOnly = ["Vacuum Upstairs", "Vacuum Downstairs", "Bathroom"];
    const VERSION = "vCloud_v1";

    function init() {
        initDates();
        document.getElementById('dbStatus').innerText = "‚óè Cloud Database Linked";
    }

    function initDates() {
        const select = document.getElementById('weekSelect');
        let d = new Date();
        d.setDate(d.getDate() + (1 - d.getDay() + 7) % 7);
        for (let i = 0; i < 4; i++) {
            let dateStr = d.toLocaleDateString('en-NZ', { day: '2-digit', month: 'short' }).replace(' ', '-').toUpperCase();
            let option = new Option(`Week starting Mon ${dateStr}`, d.toISOString().split('T')[0]);
            select.add(option);
            d.setDate(d.getDate() + 7);
        }
    }

    function getChores(day) {
        return (day === "Saturday") ? [...dinnerChores, ...saturdayOnly] : dinnerChores;
    }

    // --- FETCH DATA FROM CLOUD ---
    async function loadUser() {
        const name = document.getElementById('userSelect').value;
        if (!name) { document.getElementById('availSection').style.display = 'none'; return; }
        document.getElementById('availSection').style.display = 'block';
        const list = document.getElementById('choreList');
        list.innerHTML = 'Fetching cloud data...';

        const { data } = await _supabase.from('availability').select('selections').eq('name', name).single();
        const saved = data ? data.selections : null;

        list.innerHTML = '';
        days.forEach(day => {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'day-box';
            let html = `<div class="day-title"><b>${day}</b> <span onclick="clearDay('${day}')" style="color:#ef4444; font-size:10px; cursor:pointer;">UNAVAILABLE</span></div>`;
            getChores(day).forEach(chore => {
                const id = day + '-' + chore;
                const checked = (saved === null) ? true : saved.includes(id);
                html += `<div class="chore-row ${checked ? 'active' : ''}"><span>${chore}</span><input type="checkbox" value="${id}" class="c-box" ${checked ? 'checked' : ''} onchange="this.parentElement.classList.toggle('active')"></div>`;
            });
            dayDiv.innerHTML = html;
            list.appendChild(dayDiv);
        });
    }

    async function saveToCloud() {
        const name = document.getElementById('userSelect').value;
        const btn = document.getElementById('saveBtn');
        const selections = Array.from(document.querySelectorAll('.c-box:checked')).map(b => b.value);
        btn.innerText = "UPLOADING...";
        const { error } = await _supabase.from('availability').upsert({ name, selections });
        if (error) alert("Save failed: " + error.message);
        else { alert("Cloud Save Success!"); btn.innerText = "SAVE TO CLOUD"; }
    }

    // --- ROSTER LOGIC ---
    async function generate() {
        const { data, error } = await _supabase.from('availability').select('*');
        if (error) { alert("Fetch error: " + error.message); return; }

        const isOk = (p, d, c) => {
            const row = data.find(r => r.name === p);
            const prefs = row ? row.selections : null;
            return (prefs === null) ? true : prefs.includes(d + '-' + c);
        };

        const startDate = new Date(document.getElementById('weekSelect').value);
        let tally = { Nathan:0, Sam:0, Hannah:0, Emily:0 };
        let cooks = {};
        let monThu = ["Monday", "Tuesday", "Wednesday", "Thursday"];
        
        // 1. Assign Sam/Hannah (1 night Mon-Thu)
        let sDay = monThu.find(d => isOk("Sam", d, "Cook"));
        if (sDay) cooks[sDay] = "Sam";
        let hDay = monThu.find(d => isOk("Hannah", d, "Cook") && d !== sDay);
        if (hDay) cooks[hDay] = "Hannah";
        days.forEach(d => { if (!cooks[d]) cooks[d] = "Nathan"; });

        let nOut = days.filter(d => cooks[d] === "Nathan" && !isOk("Nathan", d, "Cook")).length;

        // 2. Compute Week Data
        let schedule = {};
        days.forEach(day => {
            schedule[day] = {};
            let dinnerSet = [];
            
            let chef = cooks[day];
            let actualChef = "UNASSIGNED";
            if (chef === "Nathan" && nOut > 2 && !isOk("Nathan", day, "Cook")) actualChef = "TAKEOUT! üçï";
            else if (isOk(chef, day, "Cook")) { actualChef = chef; dinnerSet.push(chef); }
            else { 
                actualChef = users.find(u => isOk(u, day, "Cook")) || "TAKEOUT! üçï";
                if (actualChef !== "TAKEOUT! üçï") dinnerSet.push(actualChef);
            }
            schedule[day]["Cook"] = actualChef;

            getChores(day).forEach(chore => {
                if (chore === "Cook") return;
                let p = "UNASSIGNED";
                let avail = users.filter(u => isOk(u, day, chore));
                if (dinnerChores.includes(chore)) avail = avail.filter(u => !dinnerSet.includes(u));
                if (chore === "Vacuum Downstairs") avail = avail.filter(u => u === "Hannah" || u === "Sam");
                if (chore === "Vacuum Upstairs") avail = avail.filter(u => u === "Nathan");

                if (avail.length > 0) {
                    avail.sort((a,b) => tally[a] - tally[b]);
                    p = avail[0];
                    tally[p]++;
                    if (dinnerChores.includes(chore)) dinnerSet.push(p);
                }
                schedule[day][chore] = p;
            });
        });

        // 3. Render Grid
        const allChores = ["Pre-dinner", "Cook", "Post-dinner", "Vacuum Upstairs", "Vacuum Downstairs", "Bathroom"];
        let html = '<table><thead><tr><th class="chore-col">CHORE</th>';
        days.forEach((day, index) => {
            let d = new Date(startDate);
            d.setDate(startDate.getDate() + index);
            let ds = `${d.getDate().toString().padStart(2,'0')}-${d.toLocaleString('en-NZ', {month:'short'}).toUpperCase()}`;
            html += `<th>${day}<span class="date-label">${ds}</span></th>`;
        });
        html += '</tr></thead><tbody>';
        
        allChores.forEach(chore => {
            html += `<tr><td class="chore-col">${chore}</td>`;
            days.forEach(day => {
                let p = schedule[day][chore] || '<span style="color:#ddd">-</span>';
                let style = p.includes('TAKEOUT') ? 'color:#ef4444' : 'color:#4f46e5';
                html += `<td><span class="person-val" style="${style}">${p}</span></td>`;
            });
            html += '</tr>';
        });
        document.getElementById('result').innerHTML = html + '</tbody></table>';
    }

    async function hardReset() {
        if(confirm("DANGER: This wipes every person's cloud data for the new week. Continue?")) {
            await _supabase.from('availability').delete().neq('name', 'dummy');
            location.reload();
        }
    }
    function setAll(v) { document.querySelectorAll('.c-box').forEach(b => { b.checked = v; b.parentElement.classList.toggle('active', v); }); }
    function clearDay(d) { document.querySelectorAll('.c-box').forEach(b => { if(b.value.startsWith(d)) { b.checked = false; b.parentElement.classList.remove('active'); }}); }
</script>
</body>
</html>
